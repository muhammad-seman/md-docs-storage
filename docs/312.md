# CHECKOUT DRIVER & WORKSHOP STEPS LOGIC - api-irdc-gems

## 1. ENDPOINT/CONTROLLER CHECKOUT

### Main Checkout Endpoint: checkOutDailyAttendance
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_attendance_controller.js
**Lines:** 479-651

Key Logic:
- Line 493: Validasi P2H dan FTW sebelum checkout (workshop steps check)
- Line 495-501: Validasi jika belum checkin
- Line 503-507: Validasi P2H/FTW completion (WORKSHOP STEPS)
- Line 509-535: Calculate total working time dan shift end time
- Line 537-557: Update checkout_at dan daily_task_equipment
- Line 559-593: Handle overshifted logic dengan point calculation

### Check-in Endpoint: checkInDailyAttendance
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_attendance_controller.js
**Lines:** 375-469

Key Logic:
- Line 378-383: Validasi request dari mobile/obu atau admin
- Line 384-385: Get current shift date
- Line 387-411: Validasi roster plan schedule
- Line 413-418: Get atau create daily attendance
- Line 420-447: Handle shift change (previous attendance cleanup)
- Line 449-469: Create log dan publish MQTT

### New Check-in Driver: checkInDriver
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_attendance_controller.js
**Lines:** 652-708

Key Logic:
- Line 670-680: Get current shift check-in time
- Line 682-703: Validasi roster plan untuk hari ini
- Line 705: Create daily attendance dengan shift otomatis

---

## 2. VALIDASI WORKSHOP STEPS SAAT CHECKOUT

### P2H (Prestart Health Check) Validation
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_attendance_controller.js
**Line 493:**
```javascript
if ((dailyAttendance.p2h_at === null || dailyAttendance.ftw_at === null) && !overshifted) {
  return res.status(400).json({
    status: "error",
    message: "Tidak dapat checkout sebelum bekerja",
  });
}
```

### P2H Answer Storage: storeDailyP2HAnswer
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_p2h_answer_controller.js
**Lines:** 355-450+

Key Logic:
- Line 378-405: Find daily attendance dan validate
- Line 407-423: Update P2H answers dengan is_reviewed, reviewed_at, reviewed_by
- Line 425-445: Publish MQTT untuk p2h-request atau p2h-approval
- Line 447-449: Send email notification

### P2H Answer Approval Per Category
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_p2h_answer_controller.js
**Lines:** 234-330

Key Logic:
- Line 249-280: Update is_reviewed status per category
- Line 281-297: Check if all answers reviewed
- Line 298-305: Update p2h_status based on restricted_permission
- Line 310-320: Publish MQTT p2h-approval or p2h-request

### FTW (First Trip of the Week) Validation
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_ftw_answer_controller.js
**Lines:** 131-227

Key Logic:
- Line 145: Validasi daily attendance exists
- Line 147: Validasi belum di-score
- Line 149-165: Destroy previous answers dan create new ones
- Line 167-185: Calculate FTW score dan fatigue status
- Line 187-227: Publish MQTT untuk ftw-request atau ftw-approval

---

## 3. HANDLING SHIFT CHANGE

### Shift Change Logic: checkInDailyAttendance
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_attendance_controller.js
**Lines:** 420-447

Key Logic:
```javascript
// Line 420-425: Get previous attendance (belum checkout)
const [driverBeforeAttendance] = await Promise.all([
  DailyAttendance.findOne({
    where: {
      driver_id: driverId,
      id: { [Sequelize.Op.ne]: dailyAttendance.id },
      checkout_at: null,
    },
    order: [["created_at", "DESC"]],
  }),
  ...
]);

// Line 437-447: Auto-checkout previous attendance
if (driverBeforeAttendance) {
  await DailyAttendance.update(
    {
      checkout_at: now,
      total_working_time: beforeTotalWorkingTime,
    },
    { where: { id: driverBeforeAttendance.id } }
  );
}
```

### Shift Validation: checkShift
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_attendance_controller.js
**Lines:** 709-783

Key Logic:
- Line 713-726: Get current shift dan latest checkin
- Line 728-743: Validate shift constraints:
  - Line 734: Tidak bisa checkin hari yang sama
  - Line 738-740: Tidak bisa checkin shift 1 setelah shift 2 hari sebelumnya (SHIFT CHANGE VALIDATION)

### Database Model: daily_attendance.js
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/models/v2/daily_attendance.js
**Lines:** 1-50

Fields:
- Line 13: daily_task_equipment_id
- Line 14: driver_id
- Line 15: shift_id
- Line 16: date
- Line 17: checkin_at
- Line 18: checkout_at
- Line 19-31: FTW fields (ftw_score, ftw_fatigue_status, ftw_status, ftw_at, ftw_selfie_path, etc.)
- Line 32-37: P2H fields (p2h_status, p2h_at, p2h_notes, p2h_selfie_path)

---

## 4. FTW (FIRST TRIP OF THE WEEK) LOGIC

### FTW Question Model
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/models/v2/ftw_question.js

Questions:
- Question 1: Durasi tidur semalam
- Question 2: Konsumsi obat-obatan
- Question 3: Masalah kesehatan
- Question 4: Durasi tidur sehari sebelumnya
- Question 5: Durasi tidur 2 hari sebelumnya
- Question 6: Waktu bangun

### FTW Score Calculation
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/controllers/v2/daily_ftw_answer_controller.js
**Lines:** 228-297

Key Logic:
```javascript
// Line 267-280: Calculate formula
const oneDaySleepScore = scores[4];
const twoDaySleepScore = scores[5];
const wakeUpScore = scores[6] - twoDaySleepScore;
const result = oneDaySleepScore + twoDaySleepScore + wakeUpScore;

// Line 282-297: Fatigue status based on score
// isDrugOrIssue check (Q2 or Q3 = Ya)
```

### FTW Routes
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/routes/v2/daily_ftw_answer_routes.js

Endpoints:
- GET /daily-ftw-answers: Get FTW answers dengan pagination
- POST /daily-ftw-answers: Store FTW answer
- POST /daily-ftw-answers/calculate: Calculate fatigue status
- POST /daily-ftw-answers/:id/approval: Approve FTW

---

## 5. KEY VALIDATION POINTS AT CHECKOUT

### Line 493 - Main Checkout Validation
```javascript
if ((dailyAttendance.p2h_at === null || dailyAttendance.ftw_at === null) && !overshifted) {
  return res.status(400).json({
    status: "error",
    message: "Tidak dapat checkout sebelum bekerja",
  });
}
```

Kondisi:
1. p2h_at harus tidak null (P2H sudah diisi)
2. ftw_at harus tidak null (FTW sudah diisi)
3. KECUALI jika status overshifted (sudah lampau jam kerja)

---

## 6. ROUTES & ENDPOINTS

### Daily Attendance Routes
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/routes/v2/daily_attendance_routes.js

```javascript
GET  /latest              -> latestDailyAttendance
GET  /dashboard           -> todayDailyAttendance
GET  /history             -> getHistoryDailyAttendance
GET  /check-shift         -> checkShift
GET  /:id                 -> getDailyAttendanceDetail
POST /check-in            -> checkInDailyAttendance
POST /checkin             -> checkInDriver (new)
POST /check-out           -> checkOutDailyAttendance
```

### Daily P2H Answer Routes
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/routes/v2/daily_p2h_answer_routes.js

Main endpoints untuk P2H workshop steps

### Daily FTW Answer Routes
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/routes/v2/daily_ftw_answer_routes.js

Main endpoints untuk FTW workshop steps

---

## 7. HELPER FUNCTIONS

### Overshifted Check
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/helpers/overshifted.js
**Lines:** 1-150

Functions:
- getOvershifted(workerId): Check if driver is overshifted
- getOvershiftedByCase(workerId): Get detailed overshift info

Logic:
- Line 50-90: Check if checkout_at > time_end (overshifted by time)
- Line 91-96: Check consecutive shift overshift

### Longshift Check
**File:** /Users/macbook/Documents/MINERGO/api-irdc-gems/helpers/longshift.js
**Lines:** 1-45

Function:
- getLongshift(dailyAttendance, shift): Check if work duration > 12 hours

---

## SUMMARY DIAGRAM

```
CHECK-IN
├─ Validasi roster plan schedule
├─ Get/Create daily attendance
├─ Handle shift change (auto-checkout previous)
└─ Update RosterPlanSchedule actual_shift_code

WORKSHOP STEPS (selama shift):
├─ P2H (Prestart Health Check)
│  └─ storeDailyP2HAnswer
│     ├─ Update p2h_at, p2h_status, p2h_filled_by
│     └─ Publish MQTT p2h-request/approval
└─ FTW (First Trip of the Week)
   └─ storeDailyFTWAnswer
      ├─ Calculate ftw_score, ftw_fatigue_status
      ├─ Update ftw_at, ftw_status, ftw_filled_by
      └─ Publish MQTT ftw-request/approval

CHECK-OUT
├─ Validasi P2H_at & FTW_at (UNLESS overshifted)
├─ Calculate total_working_time
├─ Handle overshifted logic
│  └─ Create DriverPoints records
├─ Update getSummaryTask
└─ Publish MQTT drvatt/checkout

SHIFT CHANGE VALIDATION:
├─ checkShift endpoint validasi:
│  ├─ Tidak checkin hari sama
│  ├─ Tidak checkin shift 1 setelah shift 2 kemarin
└─ checkInDailyAttendance auto-checkout previous
```